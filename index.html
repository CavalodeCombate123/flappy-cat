<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Flappy Cat</title>
<link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ---------------------------- Estilos Gerais Otimizados ---------------------------- */
body {
    margin: 0;
    overflow: hidden;
    font-family: Arial, sans-serif;
    
   /* ------------------- OP√á√ÉO 1: Fundo com GIF Animado ------------------- */
    background-image: url('noite1.gif'); /* ‚¨ÖÔ∏è Mude a URL aqui! */
    background-size: cover;          /* ‚¨ÖÔ∏è Sugest√£o: 'cover' √© melhor para preencher a tela */
    background-position: center;     
    background-repeat: no-repeat;    /* ‚¨ÖÔ∏è Sugest√£o: 'no-repeat' evita repeti√ß√£o do GIF */
    background-attachment: fixed;     
    background-color: #1a1a3a;      
    /* ------------------------------------------------------------------------- */
    
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

/* Container do Jogo: Usa unidades de viewport para ser totalmente responsivo */
#game-container {
    position: relative;
    width: 99vw;
    height: 99vh;
    max-width: 593px;
    max-height: 704px;
    margin: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    border-radius: 8px;
    align-self: center;
    border: 10px solid #000000; /* Moldura preta e grossa */
}

/* Canvas do Jogo e Confetti */
canvas {
    display: block;
    width: 100%;
    height: 100%;
    border-radius: 8px;
    touch-action: none;
}

/* Overlay Tela Inicial, Pause e Game Over: Usa flexbox para centralizar tudo */
.screen-overlay {
    position: absolute;
    top:0; left:0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85); 
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    border-radius: 8px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.4s; 
    z-index: 10;
    background-size: cover; 
    background-position: center;
    background-repeat: no-repeat;
}

/* Estilo para a TELA DE PAUSE */
#pause-screen {
    /* Fundo um pouco menos opaco para dar a sensa√ß√£o de que o jogo est√° ali */
    background: rgba(0,0,0,0.7); 
}
#pause-screen button {
    margin-top: 30px !important;
}


/* TELA INICIAL: Estilo com fundo de imagem */
#start-screen {
    background-image: url('telainicio.png'); 
    background-color: #3f357f;
    justify-content: flex-end; 
    padding-bottom: 30%; 
    box-sizing: border-box;
}

#start-screen h1, #start-screen p {
    display: none; 
}

#start-screen button {
    background: #6a5acd; 
    color: white; 
    border: 3px solid #b0c4de; 
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}
#start-screen button:hover {
    background-color: #836cdc; 
    box-shadow: 0 6px 15px rgba(0,0,0,0.7);
    transform: translateY(-2px); 
}


.screen-overlay.active {
    pointer-events: auto;
    opacity: 1;
}

/* T√≠tulos das outras telas */
.screen-overlay h1 {
    font-size: clamp(1.8rem,8vw,3rem);
    color: #ffcc00;
    text-shadow: 2px 2px 4px #000;
    margin-bottom: 5px;
}

.screen-overlay p {
    font-size: clamp(1rem,4vw,1.2rem);
    margin: 5px 0 20px 0;
}

/* Estilo dos bot√µes de N√≠vel (os outros bot√µes do jogo) */
#level-select-screen .level-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    max-width: 90%;
    margin-top: 20px;
}

#level-select-screen button,
.screen-overlay button {
    background: #ff99aa;
    color: #3d2b27;
    border: 3px solid #3d2b27;
    padding: 15px 15px;
    font-size: clamp(1rem,4vw,1.4rem);
    cursor: pointer;
    border-radius: 10px;
    transition: 0.2s;
    width: 90%;
    max-width: 200px;
    margin-top: 10px;
    line-height: 1.2;
}

#level-select-screen .level-list button small {
    display: block;
    font-size: 0.7em;
    font-weight: normal;
    color: #3d2b27;
    margin-top: 5px;
    opacity: 0.8;
}

#level-select-screen button:disabled {
    background: #555;
    color: #ccc;
    border-color: #333;
    cursor: not-allowed;
}


/* Placar de Pontua√ß√£o */
#score-display {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    font-size: clamp(1.2rem,5vw,1.8rem);
    font-weight: bold;
    color: #3d2b27;
    text-shadow: 2px 2px 0 white;
    z-index: 5;
    padding: 5px 10px;
    border-radius: 5px;
    background: rgba(255,255,255,0.7);
}

/* ‚è∏Ô∏è Bot√£o de Pause no Jogo */
#pause-button {
    position: absolute;
    top: 10px;
    right: 60px; /* Deslocado para n√£o colidir com o Mute */
    z-index: 20;
    background: rgba(255, 255, 255, 0.7);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    line-height: 40px;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

#pause-button:hover {
    background: rgba(255, 255, 255, 0.9);
}

/* üîä Bot√£o de Mute/Unmute */
#mute-button {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 20;
    background: rgba(255, 255, 255, 0.7);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 1.5rem;
    line-height: 40px;
    padding: 0;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}

#mute-button:hover {
    background: rgba(255, 255, 255, 0.9);
}

/* Mensagem de N√≠vel Conclu√≠do (usada como um container de vit√≥ria agora) */
#level-completed-message {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 15;
    opacity: 0;
    transition: opacity 0.5s;
    pointer-events: none;
    border-radius: 8px;
    padding: 20px;
    box-sizing: border-box;
}
#level-completed-message.active {
    opacity: 1;
    pointer-events: auto;
}

/* Altura m√°xima para permitir rolagem e for√ßar visualiza√ß√£o do fim */
#victory-text {
    font-size: clamp(1.1rem, 4vw, 1.8rem);
    font-weight: bold;
    color: #00ff7f;
    text-shadow: 2px 2px 4px #000;
    margin-bottom: 10px;
    white-space: pre-wrap;
    max-height: 60vh; 
    overflow-y: auto; 
    padding: 10px;
    line-height: 1.4;
    width: 90%;
    box-sizing: border-box;
}

/* Estilo para a imagem de vit√≥ria */
#victory-cat {
    width: clamp(100px, 30vw, 150px);
    height: auto;
    margin-top: 20px; 
    image-rendering: pixelated;
    display: block;
    opacity: 0;
    transition: opacity 0.5s;
}

/* Estilo pixelado para o bot√£o de selecionar n√≠vel na tela de vit√≥ria */
#level-completed-message button {
    background: #ffcc00;
    color: #3d2b27;
    border: 5px solid #000000;
    border-radius: 0;
    padding: 18px 25px;
    font-size: clamp(1.1rem,4.5vw,1.6rem);
    font-weight: bold;
    text-transform: uppercase;
    box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.75);
    transition: background-color 0.1s ease, box-shadow 0.1s ease;
    margin-top: 20px;
}

#level-completed-message button:hover {
    background-color: #ff9900;
    box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.75);
    transform: translate(2px, 2px);
}
</style>
</head>
<body>
<div id="game-container">
    <canvas id="game" width="480" height="640"></canvas>
    <canvas id="confetti" width="480" height="640"></canvas>

    <div id="score-display">Pontos: 0</div>

    <button id="pause-button" onclick="togglePause()" style="display:none">‚è∏Ô∏è</button>
    <button id="mute-button" onclick="toggleMute()">üîä</button>

    <div id="start-screen" class="screen-overlay">
        <button onclick="showLevelSelect()">SELECIONAR N√çVEL</button>
    </div>
    
    <div id="level-select-screen" class="screen-overlay">
        <h1>Escolha a Fase</h1>
        <p>Complete a fase atual para desbloquear a pr√≥xima!</p>
        <div class="level-list" id="level-list">
        </div>
    </div>
    
    <div id="pause-screen" class="screen-overlay">
        <h1>PAUSADO</h1>
        <p>Pressione 'P' ou clique para continuar</p>
        <button onclick="event.stopPropagation(); togglePause()">CONTINUAR (3s)</button>
        <button onclick="event.stopPropagation(); showLevelSelect()">VOLTAR PARA O MENU</button>
    </div>

    <div id="game-over-screen" class="screen-overlay">
        <h1>GAME OVER üòø</h1>
        <p id="final-score">Pontua√ß√£o Final: 0</p> 
        <button onclick="showLevelSelect()">Voltar para a Sele√ß√£o</button>
    </div>

    <div id="level-completed-message">
        <div id="victory-text"></div>
        <img id="victory-cat" src="greg.png">
        <button onclick="showLevelSelect()">Voltar para a Sele√ß√£o de N√≠veis</button>
    </div>
</div>

<script>
/* ---------------------------- Vari√°veis do Canvas e Elementos ---------------------------- */
const gameContainer = document.getElementById('game-container');
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const confCanvas = document.getElementById('confetti');
const confCtx = confCanvas.getContext('2d');

const startScreen = document.getElementById('start-screen');
const levelSelectScreen = document.getElementById('level-select-screen');
const gameOverScreen = document.getElementById('game-over-screen');
const pauseScreen = document.getElementById('pause-screen'); 
const scoreDisplay = document.getElementById('score-display');
const finalScoreText = document.getElementById('final-score');
const muteButton = document.getElementById('mute-button'); 
const pauseButton = document.getElementById('pause-button'); 

const levelCompletedScreen = document.getElementById('level-completed-message');
const victoryText = document.getElementById('victory-text');
const victoryCatImg = document.getElementById('victory-cat'); 
const levelListContainer = document.getElementById('level-list');

let imageRevealed = false; 


/* ---------------------------- Configura√ß√µes Globais e de Jogo ---------------------------- */
const pipeWidth = 70; 
const pipeInterval = 120; 
const initialDelay = 80; 
const pointsToCompleteLevel = 10; 

const FRAME_RATE = 60; 
const TIME_STEP = 1000 / FRAME_RATE; 

let lastTime = 0; 
let accumulatedTime = 0; 


let animationId = null;
let pipeFrame = 0; 
let score = 0;
let pipes = [];
let gameRunning = false;
let gameOver = false;
let currentLevel = 0; 

let isPaused = false; 

let isStarting = false;
const START_DELAY_TIME = 3000; 
let startingTimer = START_DELAY_TIME; 

let pointFeedbacks = []; 


let gravity = 0;
let jumpForce = 0;
let pipeSpeed = 0;
let minGap = 0;
let maxGap = 0; 


/* ---------------------------- DIFICULDADE FIXA E MENSAGENS ---------------------------- */
const EASY_MODE_SETTINGS = { 
    gravity: 0.3,
    jump: -7.0,
    speed: 2.25,
    gap: 200,
    maxGap: 280
};

const FINAL_VICTORY_MESSAGE = `

Parab√©ns, voc√™ completou o jogo!

Esse jogo foi algo inesperado e que surgiu na minha cabe√ßa do nada... E por isso foi algo que eu considerei muito importante, j√° que eu nunca tinha feito algo assim... Mas, aproveitei que estava estudando e tentei fazer... Ent√£o espero que tenha gostado, mesmo que s√≥ um pouco.

Layane, eu te desejo infinitas felicidades e um feliz anivers√°rio
Desejo que todas as coisas boas desse mundo, venham em sua dire√ß√£o
Espero que voc√™ sempre seja essa pessoa incrivel maravilhosa e charmosa
Voc√™ sempre foi e sempre vai ser uma pessoa muito importante na vida de todos n√≥s
E eu n√£o poderia ser mais grato por ter conhecido algu√©m como voc√™
Sua felicidade √© a alegria de todos, incluindo a minha
Meu maior desejo √© que voc√™ seja feliz em tudo o que voc√™ se proponha a fazer
Pois √© assim que eu sempre quis te ver.
E o mais importante, FELIZ ANIVERS√ÅRIO!!!

`;

const LEVEL_SETTINGS = [
    {
        name: "Gatinhos",
        message: "Uau, voc√™ √© boa nisso ein?",
        bgSrc: 'gato.png',
        pipeColor: '#332dd6',
        groundColor: '#F0E68C',
        pipeCapColor: '#44877d',
        bgmSrc: 'sfx/bgm_nivel1.mp3',
        isInfinite: false,
        ...EASY_MODE_SETTINGS
    },
    {
        name: "Parque",
        message: "Vai Corinthians... Quer dizer, V√ÉO GATINHOS!",
        bgSrc: 'world.png',
        pipeColor: '#008000',
        groundColor: '#3CB371',
        pipeCapColor: '#556B2F',
        bgmSrc: 'sfx/bgm_nivel2.mp3',
        isInfinite: false,
        ...EASY_MODE_SETTINGS
    },
    {
        name: "Piscina",
        message: "Voc√™ t√° trapaceando...",
        bgSrc: 'piscina.png',
        pipeColor: '#4682B4',
        groundColor: '#1E90FF',
        pipeCapColor: '#000080',
        bgmSrc: 'sfx/bgm_nivel3.mp3',
        isInfinite: false,
        ...EASY_MODE_SETTINGS
    },
    {
        name: "Caixa de Areia",
        message: "Mas j√°? T√° muito f√°cil!",
        bgSrc: 'deserto.png',
        pipeColor: '#964B00',
        groundColor: '#FFDAB9',
        pipeCapColor: '#A0522D',
        bgmSrc: 'sfx/bgm_nivel4.mp3',
        isInfinite: false,
        ...EASY_MODE_SETTINGS
    },
    {
        name: "Greg",
        message: "Voc√™ √© incr√≠vel! Veja a mensagem final.",
        bgSrc: 'Layane.png',
        pipeColor: '#FFD700',
        groundColor: '#800080',
        pipeCapColor: '#000000',
        bgmSrc: 'sfx/bgm_nivel5.mp3',
        isInfinite: false,
        ...EASY_MODE_SETTINGS
    },
    {
        name: "INFINITO ‚ôæÔ∏è",
        message: "O desafio nunca termina! Seu objetivo √© o recorde!",
        bgSrc: 'Layane.png', 
        pipeColor: '#7d3c98',
        groundColor: '#34495e',
        pipeCapColor: '#f1c40f',
        bgmSrc: 'sfx/bgm_nivel5.mp3',
        isInfinite: true, 
        ...EASY_MODE_SETTINGS
    }
];

/* ---------------------------- √ÅUDIO ---------------------------- */
const sfxJump = new Audio('sfx/jump.wav');
const sfxGameOver = new Audio('sfx/gameOver.wav');
const sfxVictory = new Audio('sfx/victory.wav');
const sfxPoint = new Audio('sfx/point.wav'); 

let bgMusics = {}; 
let currentBGM = null; 
let isMuted = false; 

const bgmSrcList = LEVEL_SETTINGS.map(s => s.bgmSrc); 

const audioAssets = [sfxJump, sfxGameOver, sfxVictory, sfxPoint]; 
bgmSrcList.forEach(src => {
    const audio = new Audio(src);
    audio.loop = true;
    bgMusics[src] = audio;
    audioAssets.push(audio);
});

/* ---------------------------- Assets Visuais ---------------------------- */
const cat = { x: 50, y: canvas.height/2, width: 55, height: 55, velocity:0, radius: 20 }; 
const catImg = new Image();
catImg.src = 'pngwing.com.png'; 
const sfxPointImg = new Image();
sfxPointImg.src = 'afuis-removebg-preview.png'; 

let bgImgs = {}; 
const bgSrcList = LEVEL_SETTINGS.map(s => s.bgSrc);
let bgImg = null; 
let bgX = 0; 
let bgSpeed = 0.5; 

const gregHappyImg = new Image();
gregHappyImg.src = 'gregfeliz.png'; 
const gregNormalImg = new Image();
gregNormalImg.src = 'greg.png';

let unlockedLevel = 1;

let currentPipeColor = '#1a1a1a';
let currentGroundColor = '#8fbc8f';
let currentPipeCapColor = '#FFFFFF';

/* ---------------------------- üèÜ HIGH SCORE LOCAL ---------------------------- */
function getHighScore(level) {
    return parseInt(localStorage.getItem(`flappyCatHighScore_L${level}`) || 0);
}

function saveHighScore(level, score) {
    const currentHighScore = getHighScore(level);
    if (score > currentHighScore) {
        localStorage.setItem(`flappyCatHighScore_L${level}`, score);
        return score;
    }
    return currentHighScore;
}

/* ---------------------------- TELA DE N√çVEL ---------------------------- */
function renderLevelSelect() {
    levelListContainer.innerHTML = '';
    
    const maxPhaseLevel = LEVEL_SETTINGS.length - 1;
    const infiniteLevelNumber = LEVEL_SETTINGS.length;

    LEVEL_SETTINGS.slice(0, maxPhaseLevel).forEach((level, index) => { 
        const levelNumber = index + 1;
        const button = document.createElement('button');
        const currentHighScore = getHighScore(levelNumber);
        
        button.innerHTML = `N√≠vel ${levelNumber}: ${level.name}<br><small>Recorde: ${currentHighScore}</small>`;
        if (levelNumber === currentLevel) button.style.backgroundColor = '#ffcc00';
        button.onclick = () => selectLevel(levelNumber);

        if (levelNumber > unlockedLevel) {
            button.disabled = true;
            button.innerHTML = `N√≠vel ${levelNumber}: ${level.name}<br><small>Recorde: -</small>`; 
        }
        levelListContainer.appendChild(button);
    });
    
    const infiniteSettings = LEVEL_SETTINGS[infiniteLevelNumber - 1];
    const infiniteButton = document.createElement('button');
    const infiniteHighScore = getHighScore(infiniteLevelNumber);
    
    infiniteButton.innerHTML = `MODO ${infiniteSettings.name}<br><small>Recorde: ${infiniteHighScore}</small>`;
    
    if (unlockedLevel < maxPhaseLevel + 1) { 
        infiniteButton.disabled = true;
        infiniteButton.innerHTML = `MODO ${infiniteSettings.name}<br><small>Complete o N√≠vel ${maxPhaseLevel} para desbloquear</small>`;
    }

    if (infiniteLevelNumber === currentLevel) {
        infiniteButton.style.backgroundColor = '#ffcc00';
    }

    infiniteButton.onclick = () => selectLevel(infiniteLevelNumber);
    levelListContainer.appendChild(infiniteButton);
}

function showLevelSelect() {
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
    stopBGM();

    startScreen.classList.remove('active');
    gameOverScreen.classList.remove('active');
    levelCompletedScreen.classList.remove('active');
    pauseScreen.classList.remove('active');
    
    levelSelectScreen.classList.add('active');

    pauseButton.style.display = 'none'; 
    
    if (currentLevel === 0) {
        currentLevel = 1;
    }
    renderLevelSelect();
}

function selectLevel(levelNumber) {
    currentLevel = levelNumber;
    const settings = LEVEL_SETTINGS[levelNumber - 1];

    gravity = settings.gravity;
    jumpForce = settings.jump;
    pipeSpeed = settings.speed;
    minGap = settings.gap;
    maxGap = settings.maxGap;

    bgImg = bgImgs[settings.bgSrc];
    currentPipeColor = settings.pipeColor;
    currentGroundColor = settings.groundColor;
    currentPipeCapColor = settings.pipeCapColor;

    stopBGM();
    currentBGM = bgMusics[settings.bgmSrc];
    
    startGame();
}


/* ---------------------------- Fun√ß√µes Auxiliares ---------------------------- */
function handleJump() {
    if(!gameRunning) return; 
    
    sfxJump.currentTime = 0;
    sfxJump.play().catch(e => {}); 

    cat.velocity = jumpForce;
}

function togglePause() {
    if (!gameRunning && !isStarting && !isPaused) return; 

    // Pausar
    if (gameRunning || isStarting) {
        isPaused = true;
        gameRunning = false;
        isStarting = false;
        pauseScreen.classList.add('active');
        stopBGM();
        cat.velocity = 0;
    } 
    // Retomar
    else if (isPaused) {
        isPaused = false;
        pauseScreen.classList.remove('active');
        isStarting = true; 
        startingTimer = START_DELAY_TIME; 
        
        if (currentBGM && !isMuted) {
             currentBGM.play().catch(e => {});
        }
    }
}

/* ---------------------------- Fun√ß√µes de Controle de √Åudio ---------------------------- */
function toggleMute() {
    isMuted = !isMuted;
    muteButton.textContent = isMuted ? 'üîá' : 'üîä';

    audioAssets.forEach(audio => {
        audio.muted = isMuted;
    });

    if (isMuted && currentBGM) {
        currentBGM.pause();
    } 
    else if (!isMuted && (gameRunning || isStarting) && currentBGM) { 
        currentBGM.play().catch(e => {});
    }
}

function stopBGM() {
    if (currentBGM) {
        currentBGM.pause();
        currentBGM.currentTime = 0;
    }
}

/* Eventos de controle */
document.addEventListener('keydown', e => { 
    // CORRE√á√ÉO FINAL: O pulo agora s√≥ funciona se 'gameRunning' for true.
    if (gameRunning && (e.key === ' ' || e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W')) {
        e.preventDefault();
        handleJump();
    }
    if (e.key === 'p' || e.key === 'P') {
        if (gameRunning || isPaused || isStarting) {
             togglePause();
        }
    }
});
canvas.addEventListener('mousedown', () => { 
    // CORRE√á√ÉO FINAL: O pulo agora s√≥ funciona se 'gameRunning' for true.
    if(gameRunning) handleJump();
});
canvas.addEventListener('touchstart', e => { 
    // CORRE√á√ÉO FINAL: O pulo agora s√≥ funciona se 'gameRunning' for true.
    if(gameRunning) {
        e.preventDefault();
        handleJump();
    }
}, {passive:false});
pauseScreen.addEventListener('click', togglePause);


/* ---------------------------- Estado do Jogo ---------------------------- */
function startGame() {
    levelSelectScreen.classList.remove('active');
    gameOverScreen.classList.remove('active');
    pauseScreen.classList.remove('active');

    pauseButton.style.display = 'flex';

    if (currentBGM && !isMuted) {
        currentBGM.play().catch(e => console.log("M√∫sica do n√≠vel n√£o iniciada."));
    }

    resetGameData();
    gameOver = false;
    isPaused = false;
    
    isStarting = true;
    startingTimer = START_DELAY_TIME;
    gameRunning = false; 
    
    cat.y = canvas.height/2; 
    cat.velocity = 0;

    lastTime = 0;
    accumulatedTime = 0;

    if (!animationId) {
        animationId = requestAnimationFrame(draw);
    }
}

function checkScrollAndRevealImage() {
    const isScrolledToBottom = (victoryText.scrollHeight - victoryText.scrollTop) <= victoryText.clientHeight + 1;

    if (isScrolledToBottom && !imageRevealed) {
        victoryText.removeEventListener('scroll', checkScrollAndRevealImage);
        victoryCatImg.style.opacity = 1;
        imageRevealed = true;
    }
}


function endLevel() {
    const settings = LEVEL_SETTINGS[currentLevel - 1];
    
    if (settings.isInfinite) {
        return; 
    }
    
    pauseButton.style.display = 'none';

    gameRunning = false;
    isStarting = false;
    isPaused = false;
    
    stopBGM();
    sfxVictory.play();
    
    saveHighScore(currentLevel, score);
    localStorage.setItem('flappyCatUnlockedLevel', unlockedLevel);

    spawnConfetti();
    drawConfetti();

    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }

    const isFinalLevel = currentLevel === LEVEL_SETTINGS.length - 1;

    if (isFinalLevel) {
        victoryCatImg.src = gregHappyImg.src; 
    } else {
        victoryCatImg.src = gregNormalImg.src; 
    }

    victoryCatImg.style.opacity = 0;
    imageRevealed = false;

    if (isFinalLevel) {
        victoryText.textContent = FINAL_VICTORY_MESSAGE; 
        victoryText.style.color = '#fff'; 
        victoryText.style.fontWeight = 'normal';
        victoryText.style.textShadow = 'none';

        unlockedLevel = Math.max(unlockedLevel, currentLevel + 1);
        localStorage.setItem('flappyCatUnlockedLevel', unlockedLevel);

    } else {
        unlockedLevel = Math.max(unlockedLevel, currentLevel + 1);
        localStorage.setItem('flappyCatUnlockedLevel', unlockedLevel);
        victoryText.textContent = settings.message;
        victoryText.style.color = '#00ff7f'; 
        victoryText.style.fontWeight = 'bold';
        victoryText.style.textShadow = '2px 2px 4px #000';
    }

    victoryText.addEventListener('scroll', checkScrollAndRevealImage);
    setTimeout(checkScrollAndRevealImage, 100); 

    levelCompletedScreen.classList.add('active');
}

function endGame() {
    pauseButton.style.display = 'none';

    gameRunning = false;
    isStarting = false;
    isPaused = false;
    gameOver = true;

    stopBGM(); 
    sfxGameOver.play(); 
    
    const savedHighScore = saveHighScore(currentLevel, score);
    const settings = LEVEL_SETTINGS[currentLevel - 1];

    finalScoreText.innerHTML = `Pontua√ß√£o Final: ${score} (${settings.name})<br>Recorde do N√≠vel: ${savedHighScore}`;
    
    gameOverScreen.classList.add('active');
    spawnConfetti();
    drawConfetti();
    
    if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
    }
}

function resetGameData() {
    cat.y = canvas.height/2; 
    cat.velocity = 0;
    pipes = [];
    score = 0;

    pipeFrame = 0;

    bgX = 0;
    
    pointFeedbacks = [];

    scoreDisplay.textContent = `Pontos: 0`;
}


/* ---------------------------- Gera√ß√£o de Canos ---------------------------- */
function spawnPipe() {
    const currentGap = Math.random() * (maxGap - minGap) + minGap;

    const safeZoneTop = 50;
    const safeZoneBottom = canvas.height - 50 - currentGap;

    const topHeight = Math.random() * (safeZoneBottom - safeZoneTop) + safeZoneTop;

    pipes.push({
        x: canvas.width,
        top: topHeight,
        gap: currentGap,
        passed:false
    });
}


/* ---------------------------- Desenho e Colis√µes ---------------------------- */
function drawBackground() {
    const imgToDraw = bgImg;

    if (!imgToDraw || !imgToDraw.complete || imgToDraw.naturalWidth === 0) {
        ctx.fillStyle = currentGroundColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        return;
    }

    let drawWidth = canvas.width;
    let drawHeight = drawWidth * (imgToDraw.naturalHeight / imgToDraw.naturalWidth);

    if (drawHeight < canvas.height) {
        drawHeight = canvas.height;
        drawWidth = drawHeight * (imgToDraw.naturalWidth / imgToDraw.naturalHeight);
    }

    const offsetY = 0;
    if (gameRunning) { 
        bgX -= pipeSpeed * (bgSpeed / 2.25);
    }

    if (bgX <= -drawWidth) {
        bgX = 0;
    }

    ctx.drawImage(imgToDraw, bgX, offsetY, drawWidth, drawHeight);
    ctx.drawImage(imgToDraw, bgX + drawWidth, offsetY, drawWidth, drawHeight);
}
 
function drawCat() {
    ctx.save();
    ctx.translate(cat.x + cat.width/2, cat.y + cat.height/2);
    if (gameRunning) {
        ctx.rotate(Math.min(Math.PI/2, Math.max(-Math.PI/4, cat.velocity * 0.05)));
    } else {
        ctx.rotate(0);
    }
    ctx.drawImage(catImg, -cat.width/2, -cat.height/2, cat.width, cat.height);
    ctx.restore();
}

function drawPipes() {
    const PIPE_BODY_COLOR = currentPipeColor;
    const PAW_CAP_COLOR = currentPipeCapColor;
    const PAW_CAP_HEIGHT = 20;

    pipes.forEach(pipe => {
        const topHeight = pipe.top;
        const bottomY = pipe.top + pipe.gap;
        const bottomHeight = canvas.height - bottomY - 20;

        ctx.fillStyle = PIPE_BODY_COLOR;
        ctx.fillRect(pipe.x, 0, pipeWidth, topHeight);
        ctx.fillStyle = PAW_CAP_COLOR;
        ctx.fillRect(pipe.x, topHeight - PAW_CAP_HEIGHT, pipeWidth, PAW_CAP_HEIGHT);

        ctx.fillStyle = PIPE_BODY_COLOR;
        ctx.fillRect(pipe.x, bottomY, pipeWidth, bottomHeight);
        ctx.fillStyle = PAW_CAP_COLOR;
        ctx.fillRect(pipe.x, bottomY, pipeWidth, PAW_CAP_HEIGHT);
    });
}

function drawPointFeedbacks() {
    const imgSize = 40; 
    pointFeedbacks.forEach(feedback => {
        ctx.save();
        ctx.globalAlpha = feedback.opacity;
        ctx.drawImage(sfxPointImg, feedback.x, feedback.y, imgSize, imgSize);
        ctx.restore();
    });
}

function checkCircleRectangleCollision(circle, rect) {
    const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + pipeWidth));
    const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));

    const distX = circle.x - closestX;
    const distY = circle.y - closestY;
    
    const distanceSquared = (distX * distX) + (distY * distY);
    return distanceSquared < (circle.radius * circle.radius);
}

function checkCollision() {
    if (!gameRunning) return false; 
    
    if(cat.y + cat.height > canvas.height-20 || cat.y < 0) return true;

    const catCenter = {
        x: cat.x + cat.width/2,
        y: cat.y + cat.height/2,
        radius: cat.radius
    };

    for(const pipe of pipes){
        const topPipeRect = { x: pipe.x, y: 0, height: pipe.top };
        if(checkCircleRectangleCollision(catCenter, topPipeRect)) return true;

        const bottomY = pipe.top + pipe.gap;
        const bottomPipeRect = { x: pipe.x, y: bottomY, height: canvas.height - bottomY - 20 };
        if(checkCircleRectangleCollision(catCenter, bottomPipeRect)) return true;
    }

    return false;
}

/* ---------------------------- L√≥gica do Jogo e Loop Principal ---------------------------- */
function updateGameLogic() {
    if (!gameRunning) return; 
    
    const settings = LEVEL_SETTINGS[currentLevel - 1];
    const isInfiniteMode = settings.isInfinite;

    pipes.forEach(pipe => {
        pipe.x -= pipeSpeed;

        if(pipe.x+pipeWidth < cat.x && !pipe.passed){
            score++;
            pipe.passed = true;
            scoreDisplay.textContent = `Pontos: ${score}`;

            sfxPoint.currentTime = 0;
            sfxPoint.play().catch(e => {});
            
            pointFeedbacks.push({
                x: pipe.x + pipeWidth,
                y: cat.y,
                opacity: 1,
                velocity: -2
            });

            if (!isInfiniteMode && score >= pointsToCompleteLevel) {
                endLevel();
            }
        }
    });

    if(pipes.length && pipes[0].x+pipeWidth < 0) pipes.shift();

    if(pipeFrame === initialDelay || (pipeFrame > initialDelay && (pipeFrame - initialDelay) % pipeInterval === 0)) {
                spawnPipe();
    }

    pipeFrame++;

    pointFeedbacks = pointFeedbacks.filter(feedback => {
        feedback.y += feedback.velocity; 
        feedback.opacity -= 0.05; 
        return feedback.opacity > 0;
    });
}

function applyCatPhysics() {
    // CORRE√á√ÉO FINAL: A f√≠sica agora s√≥ √© aplicada se 'gameRunning' for true.
    // Isso impede qualquer movimento durante a contagem regressiva ('isStarting').
    if (gameRunning) {
        cat.velocity += gravity;
        cat.y += cat.velocity;
        
        if(cat.y < 0) {
            cat.y = 0;
            cat.velocity = 0;
        }
    }
}


function draw(currentTime) {
    if (lastTime === 0) lastTime = currentTime;
    let deltaTime = currentTime - lastTime;
    lastTime = currentTime;

    if (deltaTime > 250) deltaTime = 250;

    accumulatedTime += deltaTime;
    
    const isGameActive = gameRunning || isStarting;
    if (isPaused) {
        accumulatedTime = 0;
        lastTime = currentTime; 
    } else if (isGameActive) {
        
        if (isStarting) {
            startingTimer -= deltaTime;
            if (startingTimer <= 0) {
                isStarting = false;
                gameRunning = true; 
                startingTimer = 0;
                accumulatedTime = 0; 
            }
        }

        let updateCount = 0;
        while (accumulatedTime >= TIME_STEP) {
            // A f√≠sica e a l√≥gica do jogo s√≥ rodam quando gameRunning = true
            if(gameRunning) {
                applyCatPhysics(); 
                updateGameLogic(); 
            }

            if(gameRunning && checkCollision()) {
                endGame();
                accumulatedTime = 0;
                break;
            }

            accumulatedTime -= TIME_STEP;
            updateCount++;

            if (updateCount > 10) { 
                accumulatedTime = 0;
                break;
            }
        }
    } else {
        accumulatedTime = 0;
        lastTime = currentTime;
    }


    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    drawBackground(); 

    ctx.fillStyle = currentGroundColor;
    ctx.fillRect(0, canvas.height-20, canvas.width, 20);

    drawPipes();
    drawCat();

    drawPointFeedbacks();
    
    if (isStarting) {
        const seconds = Math.ceil(startingTimer / 1000);
        const display = seconds > 0 ? seconds : 'VAI!'; 
        
        ctx.save();
        ctx.fillStyle = 'rgba(0,0,0,0.7)';
        ctx.fillRect(0,0,canvas.width,canvas.height); 
        
        ctx.fillStyle = 'white';
        ctx.font = `bold ${canvas.width * 0.2}px Arial`; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(display, canvas.width / 2, canvas.height / 2);
        ctx.restore();
    }

    animationId = requestAnimationFrame(draw);
}

/* ---------------------------- Confetti, Assets e Inicializa√ß√£o (Mantidos) ---------------------------- */

let confetti = [];
let confettiAnimationId = null;

function spawnConfetti(){
    confetti = [];
    for(let i=0;i<100;i++){
        confetti.push({
            x: Math.random()*canvas.width,
            y: 0,
            r: Math.random()*4+2,
            d: Math.random()*100,
            color: ['#ff99aa','#ffcc00','#5c99ff'][Math.floor(Math.random()*3)]
        });
    }
    if (!confettiAnimationId) drawConfetti();
}

function drawConfetti(){
    confCtx.clearRect(0,0,canvas.width,confCanvas.height); 
    confetti.forEach(c=>{
        confCtx.fillStyle = c.color;
        confCtx.beginPath();
        confCtx.arc(c.x,c.y,c.r,0,2*Math.PI);
        confCtx.fill();
        c.y += 2 + c.d/50;
        if(c.y>confCanvas.height) c.y=0; 
    });
    
    if(gameOver || levelCompletedScreen.classList.contains('active')) {
        confettiAnimationId = requestAnimationFrame(drawConfetti); 
    } else {
        cancelAnimationFrame(confettiAnimationId);
        confettiAnimationId = null;
    }
}


let gameInitialized = false; 
function loadImage(src, container, key = null) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            if (key) {
                container[key] = img;
            }
            resolve(img);
        };
        img.onerror = reject;
        img.src = src;
    });
}

function loadAssets() {
    const assetPromises = [];
    
    assetPromises.push(loadImage(catImg.src, null));
    assetPromises.push(loadImage(sfxPointImg.src, null));
    assetPromises.push(loadImage(gregHappyImg.src, null));
    assetPromises.push(loadImage(gregNormalImg.src, null));

    bgSrcList.forEach(src => {
        assetPromises.push(loadImage(src, bgImgs, src));
    });

    assetPromises.push(loadImage('telainicio.png', null));
    
    audioAssets.forEach(audio => {
        assetPromises.push(new Promise(resolve => {
            if (audio.readyState >= 2) { 
                resolve();
            } else {
                audio.addEventListener('canplaythrough', resolve, { once: true });
                audio.addEventListener('error', resolve, { once: true });
                audio.load(); 
            }
        }));
    });

    return Promise.all(assetPromises);
}

function resizeCanvas() {
    const containerRect = gameContainer.getBoundingClientRect();
    canvas.width = containerRect.width;
    canvas.height = containerRect.height;
    confCanvas.width = containerRect.width;
    confCanvas.height = containerRect.height;

    if (!gameRunning && !isStarting) {
        cat.y = canvas.height/2;
    }
}


function initializeGame() {
    const savedLevel = parseInt(localStorage.getItem('flappyCatUnlockedLevel') || 1);
    unlockedLevel = Math.max(1, savedLevel);
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas); 

    const initialSettings = LEVEL_SETTINGS[0];
    bgImg = bgImgs[initialSettings.bgSrc];
    currentPipeColor = initialSettings.pipeColor;
    currentGroundColor = initialSettings.groundColor;
    
    gameInitialized = true;
    startScreen.classList.add('active');
    
    draw(0); 
}

// Inicializa√ß√£o
loadAssets()
    .then(initializeGame)
    .catch(error => {
        console.error("Erro ao carregar assets:", error);
        alert("Erro ao carregar os recursos do jogo. Verifique se os arquivos (imagens e √°udio) est√£o no local correto.");
        initializeGame();
    });

</script>
</body>
</html>


